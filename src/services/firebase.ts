import firebase from 'firebase/app'
import 'firebase/auth'
import 'firebase/firestore'

// Validate Firebase environment variables
const validateFirebaseConfig = () => {
  const requiredVars = [
    'VITE_FIREBASE_API_KEY',
    'VITE_FIREBASE_AUTH_DOMAIN',
    'VITE_FIREBASE_PROJECT_ID',
    'VITE_FIREBASE_STORAGE_BUCKET',
    'VITE_FIREBASE_MESSAGING_SENDER_ID',
    'VITE_FIREBASE_APP_ID'
  ];
  
  const missing = requiredVars.filter(varName => !import.meta.env[varName]);
  
  if (missing.length > 0) {
    console.error('‚ùå Missing Firebase environment variables:', missing);
    console.error('üìù Please create a .env file with the following variables:');
    console.error(requiredVars.map(v => `${v}=your_value_here`).join('\n'));
    throw new Error(`Missing Firebase config: ${missing.join(', ')}`);
  }
};

// Validate before initializing
try {
  validateFirebaseConfig();
} catch (error) {
  console.error('Firebase Configuration Error:', error);
  // Allow app to continue but with limited functionality
}

export const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY || '',
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || '',
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID || '',
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || '',
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || '',
  appId: import.meta.env.VITE_FIREBASE_APP_ID || '',
}

if (!firebase.apps.length) {
  try {
    firebase.initializeApp(firebaseConfig);
    console.log('‚úÖ Firebase initialized successfully');
  } catch (error) {
    console.error('‚ùå Firebase initialization failed:', error);
  }
}

export const auth = firebase.auth();
export const db = firebase.firestore();

// ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸàÿßŸÑÿ£ÿØŸàÿßÿ±
export const getUserRole = async (userId: string): Promise<string | null> => {
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      return userData?.role || null;
    }
    return null;
  } catch (error) {
    console.error('Error getting user role:', error);
    return null;
  }
};

export const getUserStatus = async (userId: string): Promise<string | null> => {
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      return userData?.status || null;
    }
    return null;
  } catch (error) {
    console.error('Error getting user status:', error);
    return null;
  }
};

export const isUserApproved = async (userId: string): Promise<boolean> => {
  const status = await getUserStatus(userId);
  // Allow both 'approved' and 'active' statuses for login
  return status === 'approved' || status === 'active';
};

export const getUserProfile = async (userId: string) => {
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
      return userDoc.data();
    }
    return null;
  } catch (error) {
    console.error('Error getting user profile:', error);
    return null;
  }
};
