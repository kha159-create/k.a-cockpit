name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Verify secrets are set (safe checks)
        env:
          VITE_FIREBASE_API_KEY: "${{ secrets.VITE_FIREBASE_API_KEY }}"
          VITE_GEMINI_API_KEY: "${{ secrets.VITE_GEMINI_API_KEY }}"
        run: |
          echo "üîé Checking secrets (length only)..."
          node -e "const k=process.env.VITE_FIREBASE_API_KEY||''; console.log('Firebase starts AIza?', k.startsWith('AIza')); console.log('Firebase length:', k.length);"
          node -e "const k=process.env.VITE_GEMINI_API_KEY||''; console.log('Gemini length:', k.length);"

      - name: Install deps
        run: npm ci

      - name: Build project (with env)
        env:
          VITE_FIREBASE_API_KEY: "${{ secrets.VITE_FIREBASE_API_KEY }}"
          VITE_FIREBASE_AUTH_DOMAIN: "${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}"
          VITE_FIREBASE_PROJECT_ID: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}"
          VITE_FIREBASE_STORAGE_BUCKET: "${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}"
          VITE_FIREBASE_MESSAGING_SENDER_ID: "${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}"
          VITE_FIREBASE_APP_ID: "${{ secrets.VITE_FIREBASE_APP_ID }}"
          VITE_GEMINI_API_KEY: "${{ secrets.VITE_GEMINI_API_KEY }}"
        run: |
          echo "üîç Building‚Ä¶"
          npm run build
          echo "üîç Built files (top level):"
          ls -lah dist | head -n 50
          echo "üîç Main JS bundle:"
          ls dist/assets/index-*.js | head -n 1

      - name: (Optional) Leak scan
        run: |
          echo "üîç Leak scan (should be empty):"
          grep -R "REDACTED\|VITE_FIREBASE_API_KEY\|VITE_GEMINI_API_KEY" dist || true

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: dist
          clean: true

      - name: Summary
        run: |
          echo "‚úÖ Build & Deploy finished."
          echo "Bundle (first match):"
          ls dist/assets/index-*.js | head -n 1
