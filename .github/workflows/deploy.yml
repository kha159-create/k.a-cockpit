name: Deploy to GitHub Pages (peaceiris)

on:
  push:
    branches:
      - main                              # Trigger on pushes to main
  workflow_dispatch:                      # Allow manual runs

permissions:
  contents: write                         # Required for peaceiris to push to gh-pages
  pages: read
  id-token: write

concurrency:
  group: gh-pages-deploy                  # Prevent concurrent deploys
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository         # Pull repo content
        uses: actions/checkout@v4

      - name: Use Node.js 20.x            # Ensure Node 20 as requested
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Print Node and npm versions # Quick diagnostics in logs
        run: |
          node -v
          npm -v

      # CLEAN START: fully reset installation to avoid Rollup optional dep issues
      - name: Deep clean workspace        # Remove locks, node_modules, and npm cache
        run: |
          rm -rf node_modules package-lock.json
          rm -rf ~/.npm/_cacache || true
          rm -rf node_modules/.vite || true

      - name: Install dependencies        # Fresh install; include optional for rollup native
        env:
          NPM_CONFIG_INCLUDE: optional
        run: |
          npm install --legacy-peer-deps --include=optional --no-audit --no-fund

      - name: Force reinstall Rollup      # Ensures @rollup/rollup-<platform> is present
        run: |
          npm i -D rollup@^4 --force --include=optional
          ls -la node_modules/@rollup || true

      # BUILD with fallbacks: normal ‚Üí no minify ‚Üí esbuild minify
      - name: Build project (with fallbacks)
        shell: bash
        run: |
          set -o pipefail
          echo "üèóÔ∏è  Running Vite build (default)..."
          npm run build \
          || (echo "‚ö†Ô∏è  Build failed, retrying without minify..." && npx vite build --minify=false) \
          || (echo "‚ö†Ô∏è  Build failed again, retrying with esbuild minify..." && npx vite build --minify=esbuild)
          echo "‚úÖ Build completed"

      - name: Verify build output         # Guard to ensure dist exists before publish
        run: |
          test -d dist && echo "‚úÖ dist exists" || (echo "‚ùå dist missing" && exit 1)
          test -f dist/index.html && echo "‚úÖ index.html exists" || (echo "‚ùå index.html missing" && exit 1)
          ls -la dist

      - name: Deploy to GitHub Pages      # Publish /dist to gh-pages via peaceiris
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "chore: deploy via GitHub Actions"
