# âš™ï¸ Auto-generated GitHub Actions Workflow for Vite + Firebase + Gemini
# All secrets are managed via GitHub Secrets. Do not include .env files in commits.

name: Build, Test & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build project with environment variables
      env:
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
        VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
      run: npm run build
      
    - name: ğŸ” Verify build output
      run: |
        if [ -f "dist/index.html" ]; then
          echo "âœ… Build completed successfully!"
          echo "ğŸ“ Build artifacts found in dist/ directory"
          ls -la dist/
        else
          echo "âŒ Build failed - dist/index.html not found"
          exit 1
        fi
        
    - name: ğŸ”¥ Create Firebase connection test
      run: |
        cat > firebase-test.js << 'EOF'
        import { initializeApp } from 'firebase/app';
        
        const firebaseConfig = {
          apiKey: process.env.VITE_FIREBASE_API_KEY,
          authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN,
          projectId: process.env.VITE_FIREBASE_PROJECT_ID,
          storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET,
          messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
          appId: process.env.VITE_FIREBASE_APP_ID
        };
        
        try {
          const app = initializeApp(firebaseConfig);
          console.log('âœ… Firebase connected successfully!');
          console.log('ğŸ”¥ Firebase App initialized:', app.name);
          process.exit(0);
        } catch (error) {
          console.error('âŒ Firebase connection failed:', error.message);
          process.exit(1);
        }
        EOF
        
    - name: ğŸ§ª Test Firebase connection
      env:
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
      run: |
        node firebase-test.js
        
    - name: ğŸ§¹ Cleanup test file
      run: rm -f firebase-test.js
      
    - name: ğŸ“Š Build summary
      run: |
        echo "ğŸ‰ Build Process Summary:"
        echo "âœ… Build completed successfully!"
        echo "âœ… Firebase connection verified!"
        echo "âœ… Ready to deploy!"
        echo ""
        echo "ğŸ“ˆ Build Statistics:"
        echo "ğŸ“ Total files in dist/: $(find dist/ -type f | wc -l)"
        echo "ğŸ’¾ Total size: $(du -sh dist/ | cut -f1)"
        
    - name: ğŸš€ Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: # Optional: add your custom domain here
        
    - name: ğŸ¯ Deployment success notification
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸŒ Your app is now live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ“… Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"